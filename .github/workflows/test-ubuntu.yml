name: SWHID Test Suite (Ubuntu)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    env:
      SWHID_RS_PROFILE: release
      SWHID_RS_FEATURES: git
      RUBY_VERSION: "3.2"

    steps:
      - name: Checkout test-suite
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # CRITICAL: Configure Git to preserve hash-sensitive attributes
      - name: Configure Git for SWHID testing
        shell: bash
        run: |
          git config --global core.autocrlf false
          git config --global core.filemode true
          git config --global core.precomposeunicode false
          git config --global core.quotepath false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install system dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config ruby-dev build-essential libgit2-dev

      - name: Install Python dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install .[dev]

      - name: Install Software Heritage Python tools (optional)
        shell: bash
        run: |
          python -m pip install swh.model swh.core || echo "Warning: swh-model not available"
        continue-on-error: true

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: false
        continue-on-error: true

      # --------------------------------------------------------------------
      # Ruby gem caching: use a deterministic GEM_HOME we control
      # --------------------------------------------------------------------
      - name: Configure GEM_HOME
        shell: bash
        run: |
          set -euo pipefail
          echo "GEM_HOME=${{ runner.temp }}/gem-home" >> "$GITHUB_ENV"
          echo "GEM_PATH=${{ runner.temp }}/gem-home" >> "$GITHUB_ENV"
          echo "${{ runner.temp }}/gem-home/bin" >> "$GITHUB_PATH"

      - name: Cache GEM_HOME
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/gem-home
          # If there is a Gemfile.lock, incorporate it; otherwise keep a stable key
          key: gemhome-${{ runner.os }}-ruby-${{ env.RUBY_VERSION }}-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            gemhome-${{ runner.os }}-ruby-${{ env.RUBY_VERSION }}-

      - name: Determine CPU cores
        id: cpu-cores
        shell: bash
        run: |
          echo "cores=$(nproc || echo 4)" >> "$GITHUB_OUTPUT"

      - name: Install swhid gem
        shell: bash
        run: |
          set -euo pipefail
          export MAKE="make -j${{ steps.cpu-cores.outputs.cores }}"
          if ! ruby -e "require 'swhid'" >/dev/null 2>&1; then
            gem install swhid --no-document || echo "Ruby implementation skip"
          fi

      # Rust Build & Implementation Flags
      - name: Build swhid-rs with cache
        uses: ./.github/actions/build-swhid-rs
        with:
          rust: stable
          profile: ${{ env.SWHID_RS_PROFILE }}
          features: ${{ env.SWHID_RS_FEATURES }}
          repository: swhid/swhid-rs
          ref: main
          # Token is optional for public repos - action will use GITHUB_TOKEN if not provided
          token: ${{ secrets.SWHID_RS_TOKEN != '' && secrets.SWHID_RS_TOKEN || '' }}

      - name: Add swhid-rs binary to PATH and export availability
        shell: bash
        run: |
          set -euo pipefail
          TARGET_BIN="${CARGO_TARGET_DIR:-}/release"
          if [ -f "$TARGET_BIN/swhid" ]; then
            chmod +x "$TARGET_BIN/swhid"
            echo "$TARGET_BIN" >> "$GITHUB_PATH"
            # CRITICAL: Tell the harness swhid-rs is ready
            echo "swhid_rs_available=true" >> "$GITHUB_ENV"
            echo "SWHID_RS_PATH=$TARGET_BIN" >> "$GITHUB_ENV"
          else
            echo "WARNING: swhid binary not found."
            echo "swhid_rs_available=false" >> "$GITHUB_ENV"
          fi

      - name: Verify swhid in PATH
        run: |
          if command -v swhid >/dev/null 2>&1; then
            echo "âœ… swhid found: $(which swhid)"
            swhid --help >/dev/null 2>&1 && echo "âœ… swhid is executable" || echo "âš ï¸ swhid found but not executable"
          else
            echo "âš ï¸ swhid not in PATH"
          fi

      - name: Run harness unit tests
        run: |
          pytest tests/unit/ tests/integration/ -v --tb=short
      
      - name: Run full test suite
        shell: bash
        run: |
          swhid-harness --output-format canonical --dashboard-output results.json || true

      - name: Generate HTML results table
        if: always()
        shell: bash
        run: |
          if [ -f results.json ]; then
            python scripts/view_results.py results.json --output results.html || echo "Warning: Could not generate HTML table"
            if [ -f results.html ]; then
              echo "âœ… HTML results table generated: results.html" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No results.json file found, skipping HTML generation" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-ubuntu-24.04-py3.12
          path: |
            results.json
            results.html
          retention-days: 30
      
      - name: Generate test summary
        if: always()
        shell: bash
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f results.json ]; then
            # Generate statistics
            python3 -c "import json; fp=open('results.json'); d=json.load(fp); fp.close(); a=d.get('aggregates',{}); b=a.get('by_implementation',{}); p=sum(s.get('passed',0) for s in b.values()); fa=sum(s.get('failed',0) for s in b.values()); sk=sum(s.get('skipped',0) for s in b.values()); t=p+fa+sk; r=(p/t*100) if t>0 else 0; print(f'| Metric | Value |'); print(f'|--------|-------|'); print(f'| Total Tests | {t} |'); print(f'| Passed | {p} |'); print(f'| Failed | {fa} |'); print(f'| Skipped | {sk} |'); print(f'| Success Rate | {r:.1f}% |') if b else print('| Note | Results format not recognized |')" >> $GITHUB_STEP_SUMMARY 2>&1 || echo "| Note | Error parsing results |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # Add link to HTML results if available
            if [ -f results.html ]; then
              echo "### ðŸ“Š Detailed Results" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“¥ Download the [HTML results table](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) from the artifacts." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The HTML table provides a color-coded view of all test results across all implementations." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Note | No results file (harness tests may have been skipped) |" >> $GITHUB_STEP_SUMMARY
          fi
